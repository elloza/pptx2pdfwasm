<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ZetaJS PPTX a PDF</title>

    <script>
        window.sofficeLoaded = false;

        var Module = {
            canvas: document.getElementById('qtcanvas'),
            uno_scripts: ["zeta.js", "office_thread.js"],
            locateFile(path) {
                const filePath = `${path}`;
                console.log(`üì• [Module] Solicitado archivo: ${filePath}`);
                return filePath;
            },
            onRuntimeInitialized() {
                window.sofficeLoaded = true;
                console.log("‚úÖ [Module] LibreOffice WASM cargado y listo.");
            },
            arguments: ['--headless']
        };
    </script>

    <script>
        function showError(message) {
            console.error("‚ùå ERROR:", message);
            document.getElementById("errorContainer").innerText = `‚ùå ERROR: ${message}`;
        }

        function encodeBase64(data) {
            console.log("üîÑ [Base64 Encoding] Dividiendo en bloques para evitar stack overflow...");
            const chunkSize = 8192;  // Dividimos en partes m√°s peque√±as
            let binaryString = "";
            for (let i = 0; i < data.length; i += chunkSize) {
                binaryString += String.fromCharCode(...data.slice(i, i + chunkSize));
            }
            return btoa(binaryString);
        }

        async function convertPPTX(base64data) {
            try {
                console.log("üö© [Conversi√≥n iniciada]");
                const data = Uint8Array.from(atob(base64data), c => c.charCodeAt(0));
                FS.writeFile('/tmp/input.pptx', data);
                console.log("üìÅ Archivo PPTX guardado en FS (/tmp/input.pptx)");

                const port = await Module.uno_main;
                console.log("üü¢ Puerto uno_main listo, enviando mensaje de conversi√≥n...");

                port.postMessage({
                    cmd: 'convert',
                    name: 'input',
                    from: '/tmp/input.pptx',
                    to: '/tmp/output.pdf'
                });

                return new Promise((resolve, reject) => {
                    let timeout = setTimeout(() => {
                        showError("‚è≥ ERROR: La conversi√≥n est√° tardando demasiado.");
                        reject(null);
                    }, 60000);

                    port.onmessage = e => {
                        clearTimeout(timeout);
                        console.log("üì¨ [Puerto mensaje recibido]:", e.data);

                        if (e.data.cmd === 'converted') {
                            console.log("‚úÖ [Conversi√≥n terminada correctamente]");
                            try {
                                if (!FS.analyzePath('/tmp/output.pdf').exists) {
                                    showError("‚ö†Ô∏è ERROR: El archivo PDF no fue generado.");
                                    reject(null);
                                    return;
                                }

                                const pdfData = FS.readFile('/tmp/output.pdf');
                                if (!pdfData || pdfData.length === 0) {
                                    showError("‚ö†Ô∏è ERROR: El archivo PDF est√° vac√≠o.");
                                    reject(null);
                                    return;
                                }

                                const pdfB64 = encodeBase64(pdfData);

                                FS.unlink('/tmp/input.pptx');
                                FS.unlink('/tmp/output.pdf');
                                console.log("üóëÔ∏è Archivos temporales eliminados del FS.");

                                resolve(pdfB64);
                            } catch (err) {
                                showError("‚ùå ERROR: Fallo al leer o eliminar el archivo PDF.");
                                reject(null);
                            }
                        } else if (e.data.cmd === 'start') {
                            console.log("üü¢ [Worker listo para convertir]");
                        } else {
                            showError(`‚ùå ERROR inesperado: ${JSON.stringify(e.data)}`);
                            reject(null);
                        }
                    };
                });

            } catch (error) {
                showError("‚ùå ERROR general en la conversi√≥n: " + error.message);
                return null;
            }
        }
    </script>

    <script src="soffice.js"></script>
</head>
<body>
    <h1>ZetaJS PPTX a PDF (Depuraci√≥n completa)</h1>
    <div id="errorContainer" style="color: red;"></div>
    <canvas id="qtcanvas" style="display: none;"></canvas>
</body>
</html>
